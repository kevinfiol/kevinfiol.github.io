<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta http-equiv="X-UA-Compatible" content="ie=edge"/><link rel="shortcut icon" href="/assets/favicon.png" type="image/x-icon"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono&amp;display=swap"/><link rel="stylesheet" href="https://unpkg.com/basscss@8.0.2/css/basscss.min.css"/><link rel="stylesheet" href="/css/main.css"/><link rel="stylesheet" href="/css/prism-material-dark.css"/><title>Bullet Pools with Timers in HaxeFlixel</title></head><body><div class="max-width-3 mx-auto p3 fade-in"><div class="controls px1"><a href="bullet-pools-with-timers-in-haxeflixel.md">edit</a></div><p class="h3"><a href="/">kevin f.</a></p><span class="h5 p0 m0 light-subdue">May 18, 2019</span><div class="page-content"><h1>Bullet Pools with Timers in HaxeFlixel</h1>
<p>One of the more useful features of the flixel library is the inclusion of the <a href="http://api.haxeflixel.com/flixel/group/FlxTypedGroup.html">FlxTypedGroup</a> class, which makes it easier to organize, update, and render multiple instances of an FlxBasic object. A few getter methods provide useful information such as the length of the group, or an array of every member in an instantiated group.</p>
<p>A practical application of FlxTypedGroup can be found in the <a href="https://github.com/HaxeFlixel/flixel-demos/tree/master/Arcade/FlxTeroids/source">'Asteroids' demo</a> available via the HaxeFlixel repository. FlxTypedGroup's <code>recycle</code> method allows us to resuse bullet objects without having to destroy, recreate, and reallocate memory each time. Instead, bullets can be respawned from the queue after the pool has been &quot;expended.&quot;</p>
<blockquote>
<p>Note: In the demo example available in the HaxeFlixel repository, the properties of each bullet are initialized on the fly within <code>PlayState.hx</code>. For my example, I have created a separate <code>Bullet</code> class for the sake of convenience.</p>
</blockquote>
<p>In the current PlayState, we can create and initialize a pool called <code>bullets</code> which we will populate with bullet objects from which we can spawn bullets as we please. In this case, I will create a pool with a maximum size of 3.</p>
<pre class="language-haxe"><code class="language-haxe"><span class="token keyword">class</span> PlayState <span class="token keyword">extends</span> FlxState<br><span class="token punctuation">{</span><br>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">var</span> bullets<span class="token punctuation">:</span>FlxTypedGroup<span class="token operator">&lt;</span>Bullet<span class="token operator">></span><span class="token punctuation">;</span><br>	<span class="token keyword">override</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>Void<br>	<span class="token punctuation">{</span><br>		<span class="token keyword">var</span> poolSize<span class="token punctuation">:</span>Int <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br>		<span class="token keyword">var</span> bullet<span class="token punctuation">:</span>Bullet<span class="token punctuation">;</span><br>		bullets <span class="token operator">=</span> <span class="token keyword">new</span> FlxTypedGroup<span class="token operator">&lt;</span>Bullet<span class="token operator">></span><span class="token punctuation">(</span>poolSize<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>From here, we can write a simple loop to create new bullet objects and simply add them to the existing group.</p>
<pre class="language-haxe"><code class="language-haxe"><span class="token operator">...</span><br><span class="token keyword">override</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>Void<br><span class="token punctuation">{</span><br>	<span class="token keyword">var</span> poolSize<span class="token punctuation">:</span>Int <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><br>	<span class="token keyword">var</span> bullet<span class="token punctuation">:</span>Bullet<span class="token punctuation">;</span><br>	bullets <span class="token operator">=</span> <span class="token keyword">new</span> FlxTypedGroup<span class="token operator">&lt;</span>Bullet<span class="token operator">></span><span class="token punctuation">(</span>poolSize<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">0.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>poolSize<span class="token punctuation">)</span><span class="token punctuation">{</span><br>		bullet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Bullet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		bullets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bullet<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><span class="token operator">...</span></code></pre>
<p>Within our Player class, we can then just reference the main PlayState's <code>bullets</code> pool to recycle <code>bullet</code> objects.</p>
<pre class="language-haxe"><code class="language-haxe"><span class="token keyword">if</span><span class="token punctuation">(</span>FlxG<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>justPressed<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">{</span><br>	<span class="token keyword">var</span> bullet<span class="token punctuation">:</span>Bullet <span class="token operator">=</span> PlayState<span class="token punctuation">.</span>bullets<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token comment">//YOUR BULLET VELOCITY CODE GOES HERE</span><br><span class="token punctuation">}</span></code></pre>
<p>After this, we just add our standard logic that handles bullet velocity, acceleration, or how, when, and where your Sprite class may spawn bullet objects. As seen in the example below, only 3 bullets may be on the screen at one time, with the earliest spawned bullet being replaced.</p>
<p><img src="https://kevinfiol.com/assets/blog/haxeflixel-bullet-timers/1.gif" alt="asteroids animation"></p>
<p>Building on the example of the original Asteroids arcade game, we can give each bullet a limited lifetime, meaning if the bullet does not collide with another asteroid or enemy sprite, it should cease to exist after a certain period of time. Otherwise, it would continue travelling endlessly.</p>
<p>I was able to do this using HaxeFlixel's <a href="http://api.haxeflixel.com/flixel/util/FlxTimer.html">FlxTimer</a> class, however, you may also use the standard <a href="http://api.haxe.org/haxe/Timer.html">Timer</a> class included in the Haxe Toolkit.</p>
<p>Within my <code>Bullet.hx</code> class, I declare <code>timer</code> and initialize it as an FlxTimer object in the class constructor.</p>
<pre class="language-haxe"><code class="language-haxe"><span class="token keyword">class</span> Bullet <span class="token keyword">extends</span> FlxSprite<br><span class="token punctuation">{</span><br>	<span class="token keyword">public</span> <span class="token keyword">var</span> timer<span class="token punctuation">:</span>FlxTimer<span class="token punctuation">;</span><br>	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token keyword">new</span><span class="token punctuation">(</span>X<span class="token punctuation">:</span>Float <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span>Float <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <br>	<span class="token punctuation">{</span><br>		<span class="token keyword">super</span><span class="token punctuation">(</span>X<span class="token punctuation">,</span> Y<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FlxTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token comment">//YOUR OBJECT PROPERTIES GO HERE</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">override</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span>elapsed<span class="token punctuation">:</span>Float<span class="token punctuation">)</span><span class="token punctuation">:</span>Void<br>	<span class="token punctuation">{</span><br>		<span class="token operator">...</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>Instead of creating a new FlxTimer object each time a bullet is recycled, the existing one is simply reset when needed.</p>
<p>Now back in the <code>Player.hx</code> class, we simply set and start the FlxTimer object for each bullet as they fire. The <code>start</code> method of an FlxTimer object <a href="http://api.haxeflixel.com/flixel/util/FlxTimer.html#start">takes three arguments</a>:</p>
<pre class="language-haxe"><code class="language-haxe"><span class="token function">start</span><span class="token punctuation">(</span>Time<span class="token punctuation">:</span>Float <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> ?OnComplete<span class="token punctuation">:</span>FlxTimerâ€‘<span class="token operator">></span>Void<span class="token punctuation">,</span> Loops<span class="token punctuation">:</span>Int <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>FlxTimer</code></pre>
<blockquote>
<p><strong>Time:Float</strong> How many seconds it takes for the timer to go off. If 0 then timer will fire OnComplete callback only once at the first call of update method (which means that Loops argument will be ignored).</p>
</blockquote>
<blockquote>
<p><strong>OnComplete:FlxTimer-&gt;Void</strong> Optional, triggered whenever the time runs out, once for each loop. Callback should be formed &quot;onTimer(Timer:FlxTimer);&quot;</p>
</blockquote>
<blockquote>
<p><strong>Loops:Int</strong> How many times the timer should go off. 0 means &quot;looping forever&quot;.</p>
</blockquote>
<p>In the example below, I pass <code>2.0</code> for <code>Time</code>, an anonymous function for <code>OnComplete</code> that switches the bullets <code>exists</code> flag to <code>false</code>, and <code>1</code> for <code>Loops</code> so that the function only triggers once.</p>
<pre class="language-haxe"><code class="language-haxe"><span class="token keyword">if</span><span class="token punctuation">(</span>FlxG<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>justPressed<span class="token punctuation">.</span>Z<span class="token punctuation">)</span><span class="token punctuation">{</span><br>	<span class="token keyword">var</span> bullet<span class="token punctuation">:</span>Bullet <span class="token operator">=</span> PlayState<span class="token punctuation">.</span>bullets<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	bullet<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><br>		<span class="token number">2.0</span><span class="token punctuation">,</span><br>		<span class="token keyword">function</span><span class="token punctuation">(</span>Timer<span class="token punctuation">:</span>FlxTimer<span class="token punctuation">)</span><span class="token punctuation">{</span><br>			bullet<span class="token punctuation">.</span>exists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>		<span class="token punctuation">}</span><span class="token punctuation">,</span><br>		<span class="token number">1</span><br>	<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>So now, not only do you limit the amount of bullets that can be on the screen at once, but you can limit the duration for said bullets! It's a very neat and useful mechanic for balancing your game that can be applied to any pool of FlxBasic objects you may need, whether it be enemies, ammunition, or environmental objects.</p>
<p><img src="https://kevinfiol.com/assets/blog/haxeflixel-bullet-timers/2.gif" alt="asteroids animation"></p>
</div></div></body></html>